# generated by ansible
*nat
:PREROUTING ACCEPT [0:0]
:INPUT DROP [0:0]
[0:0] -A INPUT -p icmp -j ACCEPT
[0:0] -A INPUT -p tcp --dport 22 -j ACCEPT
[0:0] -A INPUT -p tcp --dport 9100 -s {{ reverse_proxy_ip }} -j ACCEPT
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
[0:0] -A POSTROUTING -s 10.0.0.1/32 -o eth1 -j MASQUERADE
[0:0] -A POSTROUTING -s 10.0.0.0/16 -o eth0 -j MASQUERADE
{% for container in groups['containers'] %}
[0:0] -A PREROUTING -d {{ firewall_public_ip }} -p tcp --dport 22{{ hostvars[container].ctid }} -j DNAT --to-destination 10.0.{{ hostvars[container].vlan }}.{{ hostvars[container].ctid }}:22
{% if hostvars[container].role in roles_vars %}
# ports redirections for {{ container }}
{% for port in roles_vars[hostvars[container].role].redirected_ports %}
# redirection for {{ port.value }} ({{ port.proto }})
[0:0] -A PREROUTING -d {{ firewall_public_ip }} -p {{ port.proto }} --dport {{ port.value }} -j DNAT --to-destination 10.0.{{ hostvars[container].vlan }}.{{ hostvars[container].ctid }}
[0:0] -A POSTROUTING -s 10.0.0.0/16 -d 10.0.{{ hostvars[container].vlan }}.{{ hostvars[container].ctid }} -p {{ port.proto }} --dport {{ port.value }} -j MASQUERADE
[0:0] -A OUTPUT -d {{ firewall_public_ip }} -p {{ port.proto }} --dport {{ port.value }} -j DNAT --to-destination 10.0.{{ hostvars[container].vlan }}.{{ hostvars[container].ctid }}
{% endfor %}

{% endif %}
{% endfor %}
COMMIT
