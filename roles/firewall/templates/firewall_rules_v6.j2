# generated by ansible
*filter
:INPUT DROP [0:0]
[0:0] -A INPUT -p ipv6-icmp -j ACCEPT
[0:0] -A INPUT -p tcp --dport 22 -j ACCEPT
[0:0] -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
:OUTPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
[0:0] -A FORWARD -p ipv6-icmp -j ACCEPT
[0:0] -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
{% for container in groups['containers'] %}
# container {{ container }}
[0:0] -A FORWARD -s {{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}::/64 -j ACCEPT
{% if 'redirected_ports' in roles_vars[hostvars[container].role] %}
# ports redirections for {{ container }}
{% for port in roles_vars[hostvars[container].role].redirected_ports %}
# open port for {{ port.value }} ({{ port.proto }})
[0:0] -A FORWARD -d {{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}:7665:6761:6e62:7477 -p {{ port.proto }} --dport {{ port.value }} -j ACCEPT

{% endfor %}

{% endif %}
{% if hostvars[container].role == 'minecraft' %}
{% for world in hostvars[container].worlds %}
# open port for {{ world.port }} (minecraft server {{ world.world_name }})
[0:0] -A FORWARD -d {{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}:7665:6761:6e62:7477 -p udp --dport {{ world.port }} -j ACCEPT
[0:0] -A FORWARD -d {{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}:7665:6761:6e62:7477 -p tcp --dport {{ world.port }} -j ACCEPT

{% endfor %}
{% endif %}

{% endfor %}

COMMIT

*nat
:INPUT DROP [0:0]
[0:0] -A INPUT -p ipv6-icmp -j ACCEPT
[0:0] -A INPUT -p tcp --dport 22 -j ACCEPT
[0:0] -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
:PREROUTING ACCEPT [0:0]
{% for container in groups['containers'] %}
[0:0] -A PREROUTING -d {{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}::/64 -p tcp --dport 80 -j DNAT --to-destination [{{ reverse_proxy_ip6}}]:80
[0:0] -A PREROUTING -d {{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}::/64 -p tcp --dport 443 -j DNAT --to-destination [{{ reverse_proxy_ip6 }}]:443
{% if 'allow_ssh' in roles_vars[hostvars[container].role] and roles_vars[hostvars[container].role].allow_ssh %}
# allow ssh for {{ container }} at port 22{{ hostvars[container].ctid }}
[0:0] -A PREROUTING -d {{ firewall_public_ip6[:17] }}{{ firewall_ctid | hex }}:7665:6761:6e62:7477 -p tcp --dport 22{{ hostvars[container].ctid }} -j DNAT --to-destination [{{ firewall_public_ip6[:17] }}{{ hostvars[container].ctid | hex }}:7665:6761:6e62:7477]:22
{% endif %}
{% endfor %}

COMMIT

